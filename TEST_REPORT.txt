
> sweet-shop-backend@1.0.0 test
> jest --coverage

FAIL src/__tests__/auth.test.ts (8.856 s)
  ● Auth API › POST /api/auth/register › should register a new user

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

      28 |         });
      29 |
    > 30 |       expect(response.status).toBe(201);
         |                               ^
      31 |       expect(response.body).toHaveProperty('token');
      32 |       expect(response.body.user).toHaveProperty('email', 'test@example.com');
      33 |       expect(response.body.user).toHaveProperty('role', 'user');

      at Object.<anonymous> (src/__tests__/auth.test.ts:30:31)

  ● Auth API › POST /api/auth/login › should login with valid credentials

    MongoServerError: E11000 duplicate key error collection: sweet-shop-test.users index: username_1 dup key: { username: "testuser" }

      at node_modules/mongodb/src/operations/insert.ts:85:25
      at node_modules/mongodb/src/operations/command.ts:173:14

FAIL src/__tests__/inventory.test.ts (9.391 s)
  ● Console

    console.error
      Authentication error: jwt malformed

      45 |     next();
      46 |   } catch (error: any) {
    > 47 |     console.error('Authentication error:', error.message);
         |             ^
      48 |     res.status(401).json({ message: error.message || 'Token is not valid' });
      49 |   }
      50 | };

      at error (src/middleware/auth.middleware.ts:47:13)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Function.handle (node_modules/express/lib/router/index.js:175:3)
      at router (node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express/lib/router/index.js:646:15
      at next (node_modules/express/lib/router/index.js:265:14)
      at Function.handle (node_modules/express/lib/router/index.js:175:3)
      at router (node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

    console.error
      Authentication error: jwt malformed

      45 |     next();
      46 |   } catch (error: any) {
    > 47 |     console.error('Authentication error:', error.message);
         |             ^
      48 |     res.status(401).json({ message: error.message || 'Token is not valid' });
      49 |   }
      50 | };

      at error (src/middleware/auth.middleware.ts:47:13)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Function.handle (node_modules/express/lib/router/index.js:175:3)
      at router (node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express/lib/router/index.js:646:15
      at next (node_modules/express/lib/router/index.js:265:14)
      at Function.handle (node_modules/express/lib/router/index.js:175:3)
      at router (node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

  ● Inventory API › POST /api/sweets/:id/purchase › should purchase a sweet and decrease quantity

    MongoServerError: E11000 duplicate key error collection: sweet-shop-test.users index: username_1 dup key: { username: "testuser" }

      at node_modules/mongodb/src/operations/insert.ts:85:25
      at node_modules/mongodb/src/operations/command.ts:173:14

  ● Inventory API › POST /api/sweets/:id/purchase › should not purchase if insufficient stock

    MongoServerError: E11000 duplicate key error collection: sweet-shop-test.users index: email_1 dup key: { email: "test@example.com" }

      at node_modules/mongodb/src/operations/insert.ts:85:25
      at node_modules/mongodb/src/operations/command.ts:173:14

  ● Inventory API › POST /api/sweets/:id/restock › should restock a sweet as admin

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

       96 |         .send({ quantity: 20 });
       97 |
    >  98 |       expect(response.status).toBe(200);
          |                               ^
       99 |       expect(response.body.sweet.quantity).toBe(30);
      100 |     });
      101 |

      at Object.<anonymous> (src/__tests__/inventory.test.ts:98:31)

  ● Inventory API › POST /api/sweets/:id/restock › should not allow regular user to restock

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 401

      113 |         .send({ quantity: 20 });
      114 |
    > 115 |       expect(response.status).toBe(403);
          |                               ^
      116 |     });
      117 |   });
      118 | });

      at Object.<anonymous> (src/__tests__/inventory.test.ts:115:31)

FAIL src/__tests__/sweets.test.ts (12.566 s)
  ● Console

    console.error
      Authentication error: jwt malformed

      45 |     next();
      46 |   } catch (error: any) {
    > 47 |     console.error('Authentication error:', error.message);
         |             ^
      48 |     res.status(401).json({ message: error.message || 'Token is not valid' });
      49 |   }
      50 | };

      at error (src/middleware/auth.middleware.ts:47:13)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Function.handle (node_modules/express/lib/router/index.js:175:3)
      at router (node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at jsonParser (node_modules/body-parser/lib/types/json.js:113:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at cors (node_modules/cors/lib/index.js:188:7)
      at node_modules/cors/lib/index.js:224:17
      at originCallback (node_modules/cors/lib/index.js:214:15)
      at node_modules/cors/lib/index.js:219:13
      at optionsCallback (node_modules/cors/lib/index.js:199:9)
      at corsMiddleware (node_modules/cors/lib/index.js:204:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at expressInit (node_modules/express/lib/middleware/init.js:40:5)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at query (node_modules/express/lib/middleware/query.js:45:5)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Function.handle (node_modules/express/lib/router/index.js:175:3)
      at Function.handle (node_modules/express/lib/application.js:181:10)
      at Server.app (node_modules/express/lib/express.js:39:9)

    console.error
      Authentication error: jwt malformed

      45 |     next();
      46 |   } catch (error: any) {
    > 47 |     console.error('Authentication error:', error.message);
         |             ^
      48 |     res.status(401).json({ message: error.message || 'Token is not valid' });
      49 |   }
      50 | };

      at error (src/middleware/auth.middleware.ts:47:13)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Function.handle (node_modules/express/lib/router/index.js:175:3)
      at router (node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

  ● Sweets API › GET /api/sweets › should get all sweets for authenticated user

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      61 |         .set('Authorization', `Bearer ${authToken}`);
      62 |
    > 63 |       expect(response.status).toBe(200);
         |                               ^
      64 |       expect(response.body).toHaveLength(2);
      65 |     });
      66 |

      at Object.<anonymous> (src/__tests__/sweets.test.ts:63:31)

  ● Sweets API › GET /api/sweets › should require authentication

    MongoServerError: E11000 duplicate key error collection: sweet-shop-test.users index: username_1 dup key: { username: "testuser" }

      at node_modules/mongodb/src/operations/insert.ts:85:25
      at node_modules/mongodb/src/operations/command.ts:173:14

  ● Sweets API › POST /api/sweets › should not allow regular user to create sweet

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 401

       97 |         });
       98 |
    >  99 |       expect(response.status).toBe(403);
          |                               ^
      100 |     });
      101 |   });
      102 |

      at Object.<anonymous> (src/__tests__/sweets.test.ts:99:31)

----------------------|---------|----------|---------|---------|-------------------------------------------------------------------------
File                  | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                       
----------------------|---------|----------|---------|---------|-------------------------------------------------------------------------
All files             |   50.64 |    24.69 |   39.28 |   50.82 |                                                                         
 middleware           |    82.6 |    44.44 |     100 |   80.95 |                                                                         
  auth.middleware.ts  |    82.6 |    44.44 |     100 |   80.95 | 24-25,36,58                                                             
 models               |   95.23 |        0 |     100 |     100 |                                                                         
  Order.model.ts      |     100 |      100 |     100 |     100 |                                                                         
  Sweet.model.ts      |     100 |      100 |     100 |     100 |                                                                         
  User.model.ts       |   91.66 |        0 |     100 |     100 | 55                                                                      
 routes               |   44.31 |    22.53 |   29.16 |   44.65 |                                                                         
  auth.routes.ts      |    44.7 |    35.29 |   42.85 |    44.7 | 20,60-62,88,117,129-172,184-204,217-243                                 
  inventory.routes.ts |   23.52 |        0 |       0 |   23.52 | 16-44,58-80                                                             
  order.routes.ts     |      25 |        0 |       0 |      25 | 9-18,24-36,42-66                                                        
  sweet.routes.ts     |   61.17 |    32.25 |      50 |   62.65 | 10-14,32,60,78-82,90,98,112,119-126,143-147,155,160,165-167,176,190,196 
  upload.routes.ts    |   39.28 |        0 |       0 |   39.28 | 12-24,30-33,52-65                                                       
----------------------|---------|----------|---------|---------|-------------------------------------------------------------------------
Test Suites: 3 failed, 3 total
Tests:       9 failed, 9 passed, 18 total
Snapshots:   0 total
Time:        13.795 s
Ran all test suites.
